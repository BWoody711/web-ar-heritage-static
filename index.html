<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Local History AR</title>
    <script src="https://aframe.io/releases/1.3.0/aframe.min.js"></script>
    <script
      type="text/javascript"
      src="https://raw.githack.com/AR-js-org/AR.js/master/three.js/build/ar-threex-location-only.js"
    ></script>
    <script
      type="text/javascript"
      src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"
    ></script>
    <script src="https://unpkg.com/aframe-look-at-component@0.8.0/dist/aframe-look-at-component.min.js"></script>
    <script src="https://unpkg.com/@turf/turf@6/turf.min.js"></script>
    <style>
      video {
        padding: 0;
        margin: 0;
        /* width: 100%; */
        height: 100vh;
        position: fixed;
        top: 0;
        z-index: 1;
      }
      body {
        margin: 0;
        padding: 0;
      }
      .thumbMenu {
        position: fixed;
        bottom: 0;
        height: 10vh;
        width: 100%;
        display: grid;
        grid-template-columns: auto auto auto;
        z-index: 3;
      }
      .thumbButton {
        display: flex;
        justify-content: center;
        align-items: center;
        height: 100%;
        z-index: 3;
      }
      a-scene {
        /* height: 100%; */
        z-index: 2;
      }
    </style>
  </head>
  <body>
    <script>
      function backToMap() {
        window.location.href = "https://atlas.digitalhistory.ca";
      }

      let geofence_buffer = turf.polygon([
        [
          [0, 0],
          [0, 0.1],
          [0.1, 0.1],
          [0.1, 0],
          [0, 0],
        ],
      ]);

      let gps = turf.point([-1, -1]);

      let buildings = [];

      async function getBuildings(bbox) {
        const bbox_string =
          bbox.geometry.coordinates[0][0][0].toString() +
          "," +
          bbox.geometry.coordinates[0][0][1].toString() +
          "," +
          bbox.geometry.coordinates[0][1][0].toString() +
          "," +
          bbox.geometry.coordinates[0][2][1].toString();
        const res = await fetch(
          "https://atlas.digitalhistory.ca/api/buildings/?bbox=" + bbox_string
        );
        const data = await res.json();
        return data;
      }

      function parseBuildings(bbox) {
        getBuildings(bbox)
          .then((buildings) => {
            let scene = document.querySelector("a-scene");
            // Create workflow for removing old elements from the scene
            for (let x = 0; x < buildings.features.length; x++) {
              const entity = document.createElement("a-cylinder");
              const point = turf.toWgs84(
                turf.point(buildings.features[x].geometry.coordinates)
              );
              console.log({
                latitude: point.geometry.coordinates[1],
                longitude: point.geometry.coordinates[0],
              });
              entity.setAttribute("gps-new-entity-place", {
                latitude: point.geometry.coordinates[1],
                longitude: point.geometry.coordinates[0],
              });
              entity.setAttribute("look-at", "[gps-new-camera]");
              // entity.setAttribute("scale", {
              //   x: 5,
              //   y: 5,
              //   z: 5,
              // });
              entity.setAttribute("radius", 5);
              entity.setAttribute("height", 0.2);
              entity.setAttribute("rotation", "90 0 0");
              entity.setAttribute("color", "white");
              entity.addEventListener("markerFound", () => {
                alert("Clicked!!");
              });
              // alert(entity.outerHTML.toString());
              scene.appendChild(entity);
            }
          })
          .catch((err) => {
            alert(err);
          });
      }

      function createGeofence() {
        console.log("Updating geofence...");
        const geo_buffer = turf.toMercator(
          turf.bboxPolygon(
            turf.bbox(turf.buffer(gps, 200, { units: "meters" }))
          )
        );
        const building_bbox = turf.toMercator(
          turf.bboxPolygon(
            turf.bbox(turf.buffer(gps, 300, { units: "meters" }))
          )
        );
        parseBuildings(building_bbox);
        return geo_buffer;
      }

      function checkGeofence(position) {
        console.log("Checking geofence...");
        if (position.coords.latitude && position.coords.longitude) {
          gps = turf.point([
            position.coords.longitude,
            position.coords.latitude,
          ]);
          console.log(gps);
          var in_geofence = turf.booleanPointInPolygon(
            gps,
            turf.toWgs84(geofence_buffer)
          );
          if (!in_geofence) {
            geofence_buffer = createGeofence();
          }
        }
      }

      function geofenceUpdate() {
        if ("geolocation" in navigator) {
          navigator.geolocation.getCurrentPosition(checkGeofence);
        } else {
          clearInterval(geofenceChecker);
          console.log(
            "GPS is not enabled or configured properly on your device."
          );
        }
      }

      const geofenceChecker = setInterval(() => {
        geofenceUpdate();
      }, 10000);

      window.onload = geofenceUpdate();
    </script>
    <div>
      <a-scene
        vr-mode-ui="enabled: false"
        arjs="sourceType: webcam; videoTexture: true; debugUIEnabled: true"
        renderer="antialias: true; alpha: true"
      >
        <!-- Reduce max distance to 50 later -->
        <a-camera
          look-controls-enabled="false"
          arjs-device-orientation-controls="smoothingFactor: 0.1"
          gps-new-camera="gpsMinDistance: 5; maxDistance: 200; positionMinAccuracy: 10; alert: true"
        ></a-camera>
        <!-- <a-entity
          material="color: red"
          geometry="primitive: box"
          gps-new-entity-place="latitude: 43.462716; longitude: -80.542271"
          scale="15 15 15"
          position="0 20 0"
        ></a-entity> -->
      </a-scene>
      <div class="thumbMenu">
        <button class="thumbButton">Description</button>
        <button class="thumbButton">Images</button>
        <button class="thumbButton" onclick="backToMap()">Back to Map</button>
      </div>
    </div>
  </body>
</html>
