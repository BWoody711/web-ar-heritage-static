<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Local History AR</title>
    <script src="https://aframe.io/releases/1.3.0/aframe.min.js"></script>
    <script
      type="text/javascript"
      src="https://raw.githack.com/AR-js-org/AR.js/master/three.js/build/ar-threex-location-only.js"
    ></script>
    <script
      type="text/javascript"
      src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"
    ></script>
    <script src="https://unpkg.com/aframe-look-at-component@0.8.0/dist/aframe-look-at-component.min.js"></script>
    <script src="https://unpkg.com/@turf/turf@6/turf.min.js"></script>
    <style>
      #debugMenu {
        display: none;
        position: fixed;
        top: 2vh;
        right: 2vh;
        width: 30%;
        height: 20vh;
        grid-template-columns: auto;
        grid-template-rows: auto auto auto auto auto;
        z-index: 6;
        background-color: white;
        padding: 2px;
      }
      video {
        padding: 0;
        margin: 0;
        width: 180vw;
        height: 90vh;
        position: fixed;
        top: 0;
        z-index: 2;
        left: -40vw;
      }
      body {
        margin: 0;
        padding: 0;
      }
      .thumbMenu {
        position: fixed;
        bottom: 0;
        height: 8vh;
        width: 100%;
        display: grid;
        grid-template-columns: auto auto auto;
        z-index: 5;
      }
      .thumbButton {
        display: flex;
        justify-content: center;
        align-items: center;
        height: 100%;
        z-index: 5;
        background-color: white;
        border: 1px solid black;
      }
      #desc-button {
        background-color: white;
      }
      a-scene {
        z-index: 3;
      }
      #description {
        position: absolute;
        bottom: 8vh;
        height: 30vh;
        width: 88%;
        margin: 3%;
        display: none;
        grid-template-columns: auto;
        grid-template-rows: 15% auto 25%;
        z-index: 4;
        background-color: white;
        /* visibility: hidden; */
        padding: 3%;
      }
      .description-box {
        display: "flex";
        overflow-y: scroll;
      }
      #building-name {
        margin: 0px;
        padding: 0px;
      }
      h5 {
        margin: 0px;
        padding: 0px;
      }
      /* #hist-description {
        visibility: hidden;
      } */
      /* .desc-div {
        position: absolute;
        top: 15%;
        width: 90%;
      } */
      #arch-description {
        display: none;
      }
      #story-description {
        display: none;
      }
      .audio-grid {
        display: grid;
        grid-template-columns: 80% 20%;
      }
      .profile-menu {
        width: 75%;
        margin-right: 12.5%;
        margin-left: 12.5%;
        /* align-items: center; */
        display: grid;
        grid-template-columns: auto auto;
        padding-bottom: 6px;
        padding-top: 3px;
      }
      #hist-button {
        background-color: aqua;
      }
      #arch-button {
        background-color: white;
      }
      #story-button {
        background-color: white;
      }
      .profile-button {
        display: flex;
        justify-content: center;
        align-items: center;
        height: 100%;
        z-index: 5;
        background-color: white;
        border: 1px solid black;
        margin-left: 3px;
        margin-right: 3px;
      }
      #images {
        position: absolute;
        bottom: 8vh;
        height: 92vh;
        width: 100%;
        display: none;
        grid-template-columns: auto;
        grid-template-rows: 76vh 14vh;
        z-index: 4;
      }
      #image-box {
        width: 100%;
        max-height: 76vh;
        padding: 5%;
        justify-content: center;
        align-items: center;
      }
      #image-menu {
        width: 100%;
        display: grid;
        grid-template-columns: 30% 20% 30%;
        padding: 5%;
        gap: 5% 5%;
      }
      .image-button {
        background-color: white;
        border: 1px solid black;
      }
      #pois {
        position: absolute;
        bottom: 8vh;
        height: 30vh;
        width: 88%;
        margin: 3%;
        display: none;
        grid-template-columns: 100%;
        grid-template-rows: 15% auto 25%;
        z-index: 4;
        background-color: white;
        padding: 3%;
        overflow-y: scroll;
        overflow-x: hidden;
        justify-content: left;
        align-items: flex-start;
      }
      #exit-button-box {
        width: 100%;
        height: 100%;
        display: flex;
        justify-content: flex-end;
        
      }
      #exit-survey-button {
        display: flex;
        justify-content: center;
        align-items: center;
        height: 100%;
        z-index: 5;
        background-color: white;
        border: 1px solid black;
        margin-left: 3px;
        margin-right: 3px;
      }
      #poi-heading {
        margin: 0px;
        padding: 0px;
      }
      #poi-box {
        margin: 0px;
        padding: 0px;
        font-size: 12px;
      }
      ul {
        list-style-position: inside;
        padding-left: 0;
      }
    </style>
  </head>
  <body>
    <script>
      //Parameters
      //Get Buildings from API
      const bbox_size = 200;
      // const gpsRefreshInterval = 2;

      //Find Buildings in Scene
      // const minBuildingSearchDistance = bbox_size

      //Debug mode
      const queryString = window.location.search;
      const urlParams = new URLSearchParams(queryString);
      const responseID = urlParams.get('ResponseID')
      const site = urlParams.get('Site')
      const debug = urlParams.get('Debug')

      function openDebugMenu() {
        if (debug) {
          if(debug==="y"){
            document.getElementById('debugMenu').style.display = "grid";
          }
          else {
            document.getElementById('debugMenu').style.display = "none";
        }
        }
        else {
          document.getElementById('debugMenu').style.display = "none";
        }
      }

      setTimeout(openDebugMenu, 1000)
      
      //Button handlers
      function toggleSelected(selected_id) {
        ids = ["image-button", "desc-button", "poi-button"]
        for (let x=0; x<ids.length; x++) {
          //Check for selected buttons that need to be unselected
          if (document.getElementById(ids[x]).style.backgroundColor === "aqua") {
            //Make sure double clicks do nothing
            if (ids[x] !== selected_id) {
              if (ids[x] === "image-button") {
                const images = document.getElementById("images");
                const image_button = document.getElementById("image-button");
                if (image_button.style.backgroundColor === "aqua") {
                  image_button.style.backgroundColor = "white";
                  images.style.display = "none";
                }
              }
              else if (ids[x] === "desc-button") {
                const description = document.getElementById("description");
                const desc_button = document.getElementById("desc-button");
                if (desc_button.style.backgroundColor === "aqua") {
                  desc_button.style.backgroundColor = "white";
                  description.style.display = "none";
                }
              }
              else if (ids[x] === "poi-button") {
                const pois = document.getElementById("pois")
                const poi_button = document.getElementById("poi-button")
                if (poi_button.style.backgroundColor === "aqua") {
                  poi_button.style.backgroundColor = "white";
                  pois.style.display = "none";
                }
              }
            }
          }
        }

        //Tell the app what happens when you click the button
        const button = document.getElementById(selected_id)
        //Do nothing on double clicks
        if (button.style.backgroundColor !== "aqua") {
          if (selected_id === "desc-button") {
            const description = document.getElementById("description");
            button.style.backgroundColor = "aqua";
            description.style.display = "grid";
          }
          else if (selected_id === "image-button") {
            const images = document.getElementById("images");
            button.style.backgroundColor = "aqua";
            images.style.display = "grid";
          }
          else if (selected_id === "poi-button") {
            const pois = document.getElementById("pois")
            button.style.backgroundColor = "aqua";
            pois.style.display = "grid";
          }
        }
      }

      //Proceed to exit survey button
      function proceedToExitSurvey() {
        if (confirm("Are you sure you would like to proceed to the exit survey?")) {
          window.location.href = `https://uwaterloo.ca1.qualtrics.com/jfe/form/SV_5j8DIR3GLt2Ee90?ResponseIDEntrance=${responseID}&Site=${site}`
        }
      }

      //Function here to populate POI box
      function poiText() {
        const queryString = window.location.search;
        const urlParams = new URLSearchParams(queryString);
        const site = urlParams.get('Site')
        const pois = document.getElementById('poi-box')
        if (site) {
          if (site === "Bayfield") {
            pois.innerHTML = "<ul>"
              + "<li>Which Bayfield hotel burned down in 1947?</li>"
              + "<li>In the early 1900s, what did John Whiddon make behind his building on Main Street?</li>"
              + "<li>Which structure was formerly Alf Erwin's furniture and undertaker, and later part of the Bayfield Library?</li>"
              + "<li>Which architectural style is the Gairdner house built in?</li>"
              + "<li>Which Bayfield hotel expanded to include Jack Day's carriage shop?</li>"
              + "<li>Which building used to house a CIBC branch?</li>"
              + "</ul>"
          }
          else if (site === "New Hamburg") {
            pois.innerHTML = "<ul>"
              + "<li>When was the original wooden bridge on Huron Street built?</li>"
              + "<li>Who built the former Ford garage on Peel Street in 1915?</li>"
              + "<li>Why did the Queen's Hotel cease operations in 1916?</li>"
              + "<li>How many Carnegie libraries were built in Canada?</li>"
              + "<li>What architectural style characterizes the Commercial Hotel?</li>"
              + "<li>Which shopping block on the south side of Huron Street is built in the Second Empire style?</li>"
              + "</ul>"
            }
          else {
            pois.innerHTML = 'No POIs available for this site.'
          }
        }
        else {
          pois.innerHTML = "No site specified."
        }
      }

      //Toggle image
      function toggleImage(id) {
        const images = document
          .getElementById("image-box")
          .getElementsByTagName("img");
        let selected_image = 0;
        if (Array.from(images).length > 1) {
          for (let x = 0; x < images.length; x++) {
            if (images[x].style.display !== "none") {
              selected_image = images[x].id.split("-")[1];
              break;
            }
          }
          if (selected_image > 0) {
            if (id === "forward" && selected_image < images.length) {
              document.getElementById("image-" + selected_image).style.display =
                "none";
              document.getElementById(
                "image-" + (parseInt(selected_image) + 1).toString()
              ).style.display = "inline";
            } else if (id === "reverse" && selected_image > 1) {
              document.getElementById("image-" + selected_image).style.display =
                "none";
              document.getElementById(
                "image-" + (parseInt(selected_image) - 1).toString()
              ).style.display = "inline";
            }
          }
        }
      }

      //Back to map button
      // function backToMap() {
      //   window.location.href = "https://atlas.digitalhistory.ca";
      // }

      //Building Profile Menu
      function resetBuildingProfile(id) {
        const button_id = id.split("-")[0];
        const buttons = ["hist", "arch", "story"];
        for (let x = 0; x < buttons.length; x++) {
          document.getElementById(
            buttons[x] + "-button"
          ).style.backgroundColor = buttons[x] === button_id ? "aqua" : "white";
          document.getElementById(buttons[x] + "-description").style.display =
            buttons[x] === button_id ? "inline" : "none";
        }
      }

      let geofence_buffer = turf.polygon([
        [
          [0, 0],
          [0, 0.1],
          [0.1, 0.1],
          [0.1, 0],
          [0, 0],
        ],
      ]);

      let gps = turf.point([-1, -1]);

      let buildings = [];

      async function getBuildings(bbox) {
        const bbox_string =
          bbox.geometry.coordinates[0][0][0].toString() +
          "," +
          bbox.geometry.coordinates[0][0][1].toString() +
          "," +
          bbox.geometry.coordinates[0][1][0].toString() +
          "," +
          bbox.geometry.coordinates[0][2][1].toString();
        const res = await fetch(
          "https://atlas.digitalhistory.ca/api/buildings/?ar=y&bbox=" + bbox_string
        );
        const data = await res.json();
        return data;
      }

      let objects = [];

      //Function for adding buildings to the AR scene on bbox update
      function parseBuildings(bbox) {
        getBuildings(bbox)
          .then((buildings) => {
            let scene = document.querySelector("a-scene");
            //Clear previous buildings in scene
            if (objects.length > 0) {
              for (let y = 0; y < objects.length; y++) {
                document.getElementById(objects[y].id).outerHTML = "";
              }
              objects = [];
            }
            //Add new buildings to scene
            for (let x = 0; x < buildings.features.length; x++) {
              //Set attribute to increase height of bubbles
              const building_id = buildings.features[x].properties.id;

              const entity = document.createElement("a-entity");
              const point = turf.toWgs84(
                turf.point(buildings.features[x].geometry.coordinates)
              );
              entity.setAttribute("gps-new-entity-place", {
                latitude: point.geometry.coordinates[1],
                longitude: point.geometry.coordinates[0],
              });
              objects.push({ id: building_id });
              // entity.setAttribute("look-at", "[gps-new-camera]");
              entity.setAttribute("id", building_id);
              const sphere = document.createElement("a-sphere");
              sphere.setAttribute("radius", 2);
              sphere.setAttribute("color", "white");
              entity.appendChild(sphere);
              const text = document.createElement("a-text");
              text.setAttribute("color", "white");
              text.setAttribute("look-at", "[gps-new-camera]");
              text.setAttribute("scale", {
                x: 4,
                y: 4,
                z: 4,
              });
              text.setAttribute("position", {
                x: 0,
                y: 5,
                z: -0.5,
              });
              text.setAttribute("value", "");
              text.setAttribute("align", "center");
              entity.appendChild(text);
              // const plane = document.createElement("a-plane");
              // plane.setAttribute("color", "white");
              // plane.setAttribute("look-at", "[gps-new-camera]");
              // plane.setAttribute("width", 6);
              // plane.setAttribute("height", 4);
              // plane.setAttribute("opacity", 0.7);
              // plane.setAttribute("position", {
              //   x: 0,
              //   y: 0,
              //   z: -0.01,
              // });
              // entity.appendChild(plane);
              scene.appendChild(entity);
            }
          })
          .catch((err) => {
              console.log(err);
          });
      }

      //Create new BBOX if user has moved within x metres of the edge of the old one
      //Change this so BBOX appears in front of user
      function createGeofence() {
        const edge_update_distance = bbox_size * 0.8;
        console.log("Updating geofence...");
        const geo_buffer = turf.toMercator(
          turf.bboxPolygon(
            turf.bbox(
              turf.buffer(gps, bbox_size - edge_update_distance, {
                units: "meters",
              })
            )
          )
        );
        const building_bbox = turf.toMercator(
          turf.bboxPolygon(
            turf.bbox(turf.buffer(gps, bbox_size, { units: "meters" }))
          )
        );
        parseBuildings(building_bbox);
        return geo_buffer;
      }

      //Check if the user has come within x metres of the edge of the bounding box
      function checkGeofence(position) {
        console.log("Checking geofence...");
        if (position.coords.latitude && position.coords.longitude) {
          gps = turf.point([
            position.coords.longitude,
            position.coords.latitude,
          ]);
          var in_geofence = turf.booleanPointInPolygon(
            gps,
            turf.toWgs84(geofence_buffer)
          );
          if (!in_geofence) {
            geofence_buffer = createGeofence();
          }
        }
      }

      //Function for getting current GPS coordinates from device
      function geofenceUpdate() {
        if ("geolocation" in navigator) {
          navigator.geolocation.getCurrentPosition(checkGeofence);
        } else {
          clearInterval(geofenceChecker);
          console.log(
            "GPS is not enabled or configured properly on your device."
          );
        }
      }

      //Iterator to check if phone within bounding box every n milliseconds
      const geofenceChecker = setInterval(() => {
        geofenceUpdate();
      }, 3*1000);

      //Function to get building information from the atlas.digitalhistory.ca API.
      async function fetchBuildingInfo(id) {
        const res = await fetch(
          `https://atlas.digitalhistory.ca/api/building/${id}/`
        );
        const building = await res.json();
        return building;
      }

      //When the application loads, creates the geofence and adds an event listener to the camera for position updates
      window.onload = setTimeout(() => {
        geofenceUpdate();
        poiText();

        let initialAlpha = null;
        let lastMovementTime = Date.now();
        // const threshold = 0.5;
        // const timeoutDuration = 3000;
        // let totalRotation = 0;
        let heading = null;

        function getHeading(pos) { 
            heading = pos.coords.heading; 
            document.getElementById('heading').innerHTML = 'Heading: ' + pos.coords.heading.toString()
        }

        // const rotationStopEvent = new Event('rotationstop');

        function handleDeviceOrientation(event) {
            if ("geolocation" in navigator) {
              navigator.geolocation.getCurrentPosition(getHeading)
            }
            // Calculate the difference in alpha orientation   
            // if (initialAlpha !== null) {
            //   document.getElementById('previousAlpha').innerHTML = initialAlpha.toString()
            //   document.getElementById('currentAlpha').innerHTML = currentAlpha.toString()
            //   if ("geolocation" in navigator) {
            //     navigator.geolocation.getCurrentPosition(getHeading)
            //   }
            //   const deltaAlpha = angleDifference(event.alpha, initialAlpha)
            //   if (deltaAlpha > 30) {
            //     totalRotation += deltaAlpha
            //     initialAlpha = currentAlpha;
            //     lastMovementTime = Date.now();
            //   } else if (Date.now() - lastMovementTime > 1000) {
            //     if (totalRotation > 30) {
            //       // heading = currentAlpha;
            //       window.dispatchEvent(rotationStopEvent);
            //       lastMovementTime = Date.now();
            //     }
            //     totalRotation = 0;
            //   }
            //   // Reset initial alpha to the new value
            // }
            // else {
            //   initialAlpha = event.alpha;
            // }
        }

        window.addEventListener('deviceorientation', handleDeviceOrientation)

        const camera = document.querySelector("[gps-new-camera]");

        camera.addEventListener("gps-camera-update-position", () => {
            //document.getElementById('event-last-fired').innerHTML = "Event fired at " + Date.now().toString() + "!"

            function calculateBearing(cameraPosition, targetPosition) {
                const deltaX = targetPosition.x - cameraPosition.x;
                const deltaZ = targetPosition.z - cameraPosition.z;
                const bearing = Math.atan2(deltaZ, deltaX) * (180 / Math.PI); // Convert to degrees
                return (bearing + 360) % 360; // Normalize to 0-360 degrees
            }

            function angleDifference(angle1, angle2) {
              if (isNaN(angle1) || isNaN(angle2)) {
                  alert('Heading: ' + angle1.toString() + 'Bearing: ' + angle2.toString())
              }

              let diff = (angle1 - angle2) % 360;
              if (diff < -180) {
                  diff += 360;
              } else if (diff > 180) {
                  diff -= 360;
              }

              return Math.abs(diff);
          }

            let distance = 9999;
            let minDistance = 100;
            let id = 0;
            let maxAngle = 90;

            const building_markers = document.getElementsByTagName("a-entity");

            if (heading) {              
              let bearing
              let diff
              let selected_bearing
              let selected_diff
              document.getElementById('heading-enabled').innerHTML = "Heading enabled."
              for (let x = 0; x < Array.from(building_markers).length; x++) {
                distance = camera.object3D.position.distanceTo(
                  building_markers[x].object3D.position
                );
                bearing = calculateBearing(camera.object3D.position, building_markers[x].object3D.position)
                diff = angleDifference(parseInt(heading), parseInt(bearing))
                // Switch this to shortest angle calculation!!
                // diff = Math.abs(bearing - heading)
                //document.getElementById('diff').innerHTML = diff.toString()

                if (distance < minDistance && parseInt(diff) < maxAngle) {
                  minDistance = distance;
                  id = parseInt(building_markers[x].id);
                  selected_bearing = parseInt(bearing)
                  selected_diff = parseInt(diff)
                }
              }
            }
            // else {
            //   document.getElementById('heading-enabled').innerHTML = "Heading disabled."
            //   for (let x = 0; x < Array.from(building_markers).length; x++) {
            //     distance = camera.object3D.position.distanceTo(
            //       building_markers[x].object3D.position
            //     );

            //     if (distance < minDistance) {
            //       minDistance = distance;
            //       id = parseInt(building_markers[x].id);
            //       selected_bearing = bearing
            //       selected_diff = diff
            //     }
            //   }
            // }
            //If buildings are in proximity, highlight the closest one in aqua
            const highlight_color = "aqua";
            //Check if there is at least one element in range of the device
            if (id > 0) {
              alert(id)
              //Parse selected building
              // if (heading) {
              //   document.getElementById('bearing').innerHTML = 'Bearing: ' + selected_bearing.toString()
              //   document.getElementById('diff').innerHTML = 'Diff: ' + selected_diff.toString()
              // }
              //Check if that element is a different element from the one currently selected
              if (
                document
                  .getElementById(id)
                  .getElementsByTagName("a-sphere")[0]
                  .getAttribute("color") !== highlight_color
              ) {
                //Deselect currently selected element, if needed
                if (
                  Array.from(
                    document.querySelectorAll(
                      `a-sphere[color=${highlight_color}]`
                    )
                  ).length === 1
                ) {
                  document
                    .querySelectorAll(`a-sphere[color=${highlight_color}]`)[0]
                    .setAttribute("color", "white");
                  document
                    .querySelectorAll(`a-sphere[color=${highlight_color}]`)[0]
                    .parentElement.getElementsByTagName(
                      "a-text"
                    )[0].style.visiblity = "hidden";
                }
                //Select new element
                document
                  .getElementById(id)
                  .getElementsByTagName("a-sphere")[0]
                  .setAttribute("color", highlight_color);
                document
                  .getElementById(id)
                  .getElementsByTagName("a-text")[0].style.visibility = "visible";
                //Get building information for closest building
                //Set text popup above the building
                fetchBuildingInfo(id).then((building) => {
                  document
                    .getElementById(id)
                    .getElementsByTagName("a-text")[0]
                    .setAttribute(
                      "value",
                      (building.name ? "Name: " + building.name : "") +
                        (building.date_of_construction
                          ? "\nBuilt: " +
                            building.date_of_construction
                              .toString()
                              .substring(0, 4)
                          : "") +
                        (building.building_category
                          ? "\nType: " + building.building_category.name
                          : "") +
                        (building.architectural_style
                          ? "\nStyle: " + building.architectural_style.name
                          : "")
                    );
                  //Populate lower menus
                  document.getElementById("hist-description-text").innerHTML =
                    building.historical_description;
                  document.getElementById("building-name").innerHTML =
                    building.name;
                  document.getElementById("arch-description-text").innerHTML =
                    building.architectural_description;
                  //Get images
                  let image_box = document.getElementById("image-box");
                  //Clear previous images
                  image_box.innerHTML = "";
                  let children = 0;
                  //Add something if there are no images associated with the building
                  for (let y = 0; y < building.items.length; y++) {
                    if (
                      building.items[y].type === "photograph" ||
                      building.items[y].type === "postcard"
                    ) {
                      children = image_box.getElementsByTagName("img").length;
                      const img = document.createElement("img");

                      //Functionality for front and back side of postcards
                      img.setAttribute("src", building.items[y].files[0].image);
                      img.setAttribute("id", "image-" + (y + 1));
                      img.style.maxWidth = "90vw";
                      img.style.opacity = 0.7;
                      img.style.zIndex = 4;
                      img.style.marginTop = "25vh";
                      img.style.marginBottom = "25vh";
                      if (children > 0) {
                        img.style.display = "none";
                      } else {
                        img.style.display = "inline";
                      }
                      image_box.appendChild(img);
                    }
                  }
                });
              }
              // else {
              //   alert("Same element.");
              // }
            } else {
              document.getElementById("hist-description-text").innerHTML =
                "No nearby buildings in front of your device. Try rotating your device.";
              document.getElementById("building-name").innerHTML =
                "No nearby buildings in view.";
              document.getElementById("arch-description-text").innerHTML =
                "No nearby buildings in front of your device. Try rotating your device.";
              document
                .querySelectorAll(`a-sphere[color=${highlight_color}]`)[0]
                .setAttribute("color", "white");
            }
        });

        //Event listener that fires every time the GPS position of the camera updates
        // camera.addEventListener("gps-camera-update-position", (e) => {
        //   //lon, lat

        //   function calculateBearing(lat1, lon1, lat2, lon2) {
        //       const toRadians = degrees => degrees * Math.PI / 180;
        //       const toDegrees = radians => radians * 180 / Math.PI;

        //       const dLon = toRadians(lon2 - lon1);
        //       const y = Math.sin(dLon) * Math.cos(toRadians(lat2));
        //       const x = Math.cos(toRadians(lat1)) * Math.sin(toRadians(lat2)) -
        //                 Math.sin(toRadians(lat1)) * Math.cos(toRadians(lat2)) * Math.cos(dLon);
        //       const bearing = (toDegrees(Math.atan2(y, x)) + 360) % 360; // Normalize to 0-360 degrees

        //       return bearing;
        //   }

        //   if(heading) {
        //     console.log("Heading obtained successfully.")
        //     const building_markers = document.getElementsByTagName("a-entity");
        //     let distance = 999999999;
        //     let id = 0;
        //     let minDistance = 75;
        //     for (let x = 0; x < Array.from(building_markers).length; x++) {
        //       // alert(JSON.stringify(camera.object3D.position))
        //       const bearing = calculateBearing(camera.object3D.position.z, camera.object3D.position.x, building_markers[x].object3D.position.z, building_markers[x].object3D.position.x)

        //       let diff = Math.abs(bearing - heading);

        //       // Adjust if the difference is greater than 180 degrees
        //       if (diff > 180) {
        //           diff = 360 - diff;
        //       }

        //       // alert(`ID: ${building_markers[x].id}. Bearing: ${bearing}. Heading: ${heading}. Difference: ${diff}`)

        //       distance = camera.object3D.position.distanceTo(
        //         building_markers[x].object3D.position
        //       );
        //       // if (distance < 1000) {
        //       //   alert(distance);
        //       // }
        //       if (distance < minDistance && diff < 60) {
        //         minDistance = distance;
        //         id = parseInt(building_markers[x].id);
        //       }
        //     }
        //     //If buildings are in proximity, highlight the closest one in aqua
        //     const highlight_color = "aqua";
        //     //Check if there is at least one element in range of the device
        //     if (id > 0) {
        //       //Check if that element is a different element from the one currently selected
        //       console.log(
        //         document
        //           .getElementById(id)
        //           .getElementsByTagName("a-sphere")[0]
        //           .getAttribute("color")
        //       );
        //       if (
        //         document
        //           .getElementById(id)
        //           .getElementsByTagName("a-sphere")[0]
        //           .getAttribute("color") !== highlight_color
        //       ) {
        //         //Deselect currently selected element, if needed
        //         // console.log(
        //         //   document.querySelectorAll(
        //         //     `a-sphere[color=${highlight_color}]`
        //         //   )
        //         // );
        //         if (
        //           Array.from(
        //             document.querySelectorAll(
        //               `a-sphere[color=${highlight_color}]`
        //             )
        //           ).length === 1
        //         ) {
        //           document
        //             .querySelectorAll(`a-sphere[color=${highlight_color}]`)[0]
        //             .setAttribute("color", "white");
        //           document
        //             .querySelectorAll(`a-sphere[color=${highlight_color}]`)[0]
        //             .parentElement.getElementsByTagName(
        //               "a-text"
        //             )[0].style.visiblity = "hidden";
        //         }
        //         // setTimeout(() => {
        //         //Select new element
        //         document
        //           .getElementById(id)
        //           .getElementsByTagName("a-sphere")[0]
        //           .setAttribute("color", highlight_color);
        //         document
        //           .getElementById(id)
        //           .getElementsByTagName("a-text")[0].style.visibility = "visible";
        //         //Get building information for closest building
        //         fetchBuildingInfo(id).then((building) => {
        //           //Set text popup above the building
        //           document
        //             .getElementById(id)
        //             .getElementsByTagName("a-text")[0]
        //             .setAttribute(
        //               "value",
        //               (building.name ? "Name: " + building.name : "") +
        //                 (building.date_of_construction
        //                   ? "\nBuilt: " +
        //                     building.date_of_construction
        //                       .toString()
        //                       .substring(0, 4)
        //                   : "") +
        //                 (building.building_category
        //                   ? "\nType: " + building.building_category.name
        //                   : "") +
        //                 (building.architectural_style
        //                   ? "\nStyle: " + building.architectural_style.name
        //                   : "")
        //             );
        //           //Populate lower menus
        //           document.getElementById("hist-description-text").innerHTML =
        //             building.historical_description;
        //           document.getElementById("building-name").innerHTML =
        //             building.name;
        //           document.getElementById("arch-description-text").innerHTML =
        //             building.architectural_description;
        //           //Get images
        //           let image_box = document.getElementById("image-box");
        //           //Clear previous images
        //           image_box.innerHTML = "";
        //           let children = 0;
        //           //Add something if there are no images associated with the building
        //           for (let y = 0; y < building.items.length; y++) {
        //             if (
        //               building.items[y].type === "photograph" ||
        //               building.items[y].type === "postcard"
        //             ) {
        //               children = image_box.getElementsByTagName("img").length;
        //               const img = document.createElement("img");

        //               //Functionality for front and back side of postcards
        //               img.setAttribute("src", building.items[y].files[0].image);
        //               img.setAttribute("id", "image-" + (y + 1));
        //               img.style.maxWidth = "90vw";
        //               img.style.opacity = 0.7;
        //               img.style.zIndex = 4;
        //               img.style.marginTop = "25vh";
        //               img.style.marginBottom = "25vh";
        //               if (children > 0) {
        //                 img.style.display = "none";
        //               } else {
        //                 img.style.display = "inline";
        //               }
        //               image_box.appendChild(img);
        //             }
        //           }
        //         });
        //       }
        //       // else {
        //       //   alert("Same element.");
        //       // }
        //     } else {
        //       console.log(
        //         "No buildings within " + minDistance + " metres of this device."
        //       );
        //       document.getElementById("hist-description-text").innerHTML =
        //         "No nearby buildings in front of your device. Try rotating your device.";
        //       document.getElementById("building-name").innerHTML =
        //         "No nearby buildings in view.";
        //       document.getElementById("arch-description-text").innerHTML =
        //         "No nearby buildings in front of your device. Try rotating your device.";
        //       document
        //         .querySelectorAll(`a-sphere[color=${highlight_color}]`)[0]
        //         .setAttribute("color", "white");
        //     }
        //   }
        //   else {
        //     console.log("No heading found in function.")
        //   }
        // });
      }, 2000);
    </script>
    <div>
      <a-scene
        vr-mode-ui="enabled: false"
        arjs="sourceType: webcam; videoTexture: true; debugUIEnabled: true"
        renderer="antialias: true; alpha: true"
      >
        <a-camera
          look-controls-enabled="false"
          arjs-device-orientation-controls="smoothingFactor: 0.1"
          gps-new-camera="gpsMinDistance: 5; maxDistance: 75; positionMinAccuracy: 25; alert: true"
        ></a-camera>
      </a-scene>
      <div id="debugMenu">
        <span id="event-last-fired" style="display: inherit;"></span>
        <span id="heading-enabled" style="display: inherit;"></span>
        <span id="heading" style="display: inherit;"></span>
        <span id="bearing" style="display: inherit;"></span>
        <span id="diff" style="display: inherit;"></span>
      </div>
      <div class="thumbMenu">
        <button
          class="thumbButton"
          id="desc-button"
          onclick="toggleSelected(this.id)"
        >
          Description
        </button>
        <button class="thumbButton" id="image-button" onclick="toggleSelected(this.id)">
          Images
        </button>
        <button class="thumbButton" id="poi-button" onclick="toggleSelected(this.id)">
          Scavenger Hunt
        </button>
      </div>
      <div id="description">
        <h3 id="building-name">Loading nearby buildings...</h3>
        <div class="description-box">
          <div id="hist-description">
            <!-- <h5>Historical Description</h5> -->
            <div class="description-box">
              <div class="audio-grid">
                <p id="hist-description-text"></p>
                <div></div>
              </div>
            </div>
          </div>
          <div id="arch-description">
            <!-- <h5>Architectural Description</h5> -->
            <div class="audio-grid">
              <p id="arch-description-text"></p>
              <div></div>
            </div>
          </div>
          <!-- <div id="story-description">
            <h5>Comments</h5>
          </div> -->
        </div>
        <div class="profile-menu">
          <button
            class="profile-button"
            id="hist-button"
            onclick="resetBuildingProfile(this.id)"
          >
            History
          </button>
          <button
            class="profile-button"
            id="arch-button"
            onclick="resetBuildingProfile(this.id)"
          >
            Architecture
          </button>
          <!-- <button
            class="profile-button"
            id="story-button"
            onclick="resetBuildingProfile(this.id)"
          >
            Stories
          </button> -->
        </div>
      </div>
    </div>
    <div id="images">
      <div id="image-box"></div>
      <div id="image-menu">
        <button
          id="reverse"
          class="image-button"
          onclick="toggleImage(this.id)"
        >
          Back
        </button>
        <button id="close" class="image-button" onclick="toggleSelected(this.id)">
          Close
        </button>
        <button
          id="forward"
          class="image-button"
          onclick="toggleImage(this.id)"
        >
          Forward
        </button>
      </div>
    </div>
    <div id="pois">
      <h3 id="poi-heading">Scavenger Hunt</h3>
      <div id="poi-box">

      </div>
      <div id="exit-button-box">
        <button id="exit-survey-button" onclick="proceedToExitSurvey()">Proceed to Exit Survey</a>
      </div>
    </div>
  </body>
</html>
